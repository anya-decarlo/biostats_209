Biostatistics 209, Lab #3 Discussion
1. Background

The purpose of this lab is to give you practice on checking proportional hazards assumption in Cox
regression models.
2. Data

• Download the datasets lab3-actg019_a.dta and lab3-pbc_a.dta from the website
(these are altered datasets from actg019.dta and pbc.dta that you used before!).
3. Checking the Cox Model for ZDV treatment in lab3-actg019_a.dta
Declare the data lab3-actg019_a.dta to be survival time data
stset days, failure(cens)

a. Generate the Cox-KM plot and the log-minus-log KM plot by treatment (rx).

0.80

Survival Probability
0.85
0.90
0.95

1.00

stcoxkm, by(rx) obs1opts(recast(line) connect(stairstep) lcolor(blue))
obs2opts(recast(line) c(stairstep) lc(red)) pred1opts(recast(line)
c(stairstep) lc(green)) pred2opts(recast(line) c(stairstep) lc(orange))

0

200

400
analysis time

600

800

Observed: rx = ZDV

Observed: rx = Placebo

Predicted: rx = ZDV

Predicted: rx = Placebo

Some options used to customize the graphs:
recast(line)
gives no symbols at the estimate points.
connect(stairstep)
asks Stata to connect points using a step function.
lcolor(red)
specifies the line color.

1

Biostatistics 209

Lab #3

stphplot, by(rx) nonegative nolntime plot1opts(recast(line)
connect(stairstep)) plot2opts(recast(line) c(stairstep)) ytitle(Log Minus
Log Survival) xtitle(Time) legend(order(1 "ZDV" 2 "Placebo"))
scheme(s1color)
Options used:
nolntime
nonegative

-6

Log Minus Log Survival
-5
-4
-3

-2

prevents Stata from taking the log of the x-axis,
specifies the log(-log) not -log(-log) plots,

0

200

400
Time

600

ZDV

800

Placebo

b. Does the rx HR appear proportional?
Here we look to see if the log-minus-log curves display a constant distance apart.
Instead, we see the two curves coming together. This pattern is typical of a large
treatment effect that fades over time. However, it is difficult to discern from this
graph how quickly the treatment effect diminishes.
c. Graph the log hazard ratio after fitting the Cox model and save the scaled Schoenfeld
residuals. These are needed for subsequent plots and calculations. Note, by default, ZDV is
set as the reference group for the variable rx.
stcox rx, sca(giveAname)
No. of subjects =
No. of failures =
Time at risk
=

(choose a name to be used later; no “*” b/c only 1 var)

880
55
354872

Number of obs

=

880

LR chi2(1)
=
5.66
Log likelihood =
-328.57534
Prob > chi2
=
0.0174
-----------------------------------------------------------------------------_t | Haz. Ratio
Std. Err.
z
P>|z|
[95% Conf. Interval]
-------------+----------------------------------------------------------------

2

Biostatistics 209

Lab #3

rx
|
1.957118
.5719375
2.30
0.022
1.103739
3.470304
------------------------------------------------------------------------------

Placebo subjects on average have about 2 times hazard of HIV progression compared to
subjects on ZDV.
(this gives a running mean smoother, rather than lowess)

estat phtest, plot(rx)

-3

-2

scaled Schoenfeld - rx
-1
0
1

2

Test of PH Assumption

0

200

400
Time

600

800

bandwidth = .8

d. Re-graph the log hazard ratio with a lowess smoother, and save the lowess values in the
variable named “smloghr” (obviously you can call it something else).
lowess giveAname days, generate(smloghr) ytitle(rx Log Hazard Ratio)

3

Biostatistics 209

Lab #3

-3

-2

rx Log Hazard Ratio
-1
0
1

2

Lowess smoother

0

200

400
Days Since Randomization

bandwidth =.8

4

600

800

Biostatistics 209

Lab #3

Note the difference in the smoothers (seen in the two different graphs); the running mean
smoother on the left is rather flat, as running mean smoothers tend to be. The lowess
shows a more pronounced trajectory. In the lowess graph, we can see that the log HR
decreases with time, which indicates violations of proportional hazards. I have included a
flat reference line at log(1.96) = 0.67. If hazards were truly proportional the lowess line
should be approximately flat.
e. Look at the graph and the variable smloghr and fill in the following table.
gen smhr=exp(smloghr)
sort days
list days smloghr smhr if cens==1 &(days==95|days==181|days==362|days==540)

log HR

HR

95 days (3 mos)

1.71

5.52

181 days (6 mos)

1.46

4.31

362 days (12 mos)

0.71

2.03

540 days (18 mos)

0.19

1.21

However, be aware that choosing a different bandwidth (default bwidth=0.8) would
change the values in the table, e.g.
lowess giveAname days, bwidth(.5) generate(smloghr2)
leads to:

log HR

HR

95 days (3 mos)

1.70

5.48

181 days (6 mos)

1.67

5.32

362 days (12 mos)

0.61

1.83

540 days (18 mos)

0.23

1.25

f. Run the Schoenfeld test for the proportional hazards assumption. Is there evidence against
that? Does this agree with the plots?
estat phtest, detail

5

Biostatistics 209

Lab #3

Test of proportional-hazards assumption
Time: Time
---------------------------------------------------------------|
rho
chi2
df
Prob>chi2
------------+--------------------------------------------------rx
|
-0.30819
5.39
1
0.0202
------------+--------------------------------------------------global test |
5.39
1
0.0202
----------------------------------------------------------------

The test agrees closely with the plots in concluding that there is a violation of
proportional hazards. The HR’s over time appear quite different despite the p-value=0.02
being not overwhelmingly so. This reflects the moderate sample size (55 events).
g. How would you summarize the effect of ZDV on progression of HIV?
Tests and graphical examination showed that the effect of ZDV violated the assumption
of proportional hazards (p=0.02); that is, the effect of ZDV appeared to decrease over
time.
h. Consider the “stratification” approach to dealing with non-proportional hazards: run the logrank test to conclude that the effect of ZDV is significant and present the K-M plot to show
its effect on being free of HIV progression. Note that this approach does not provide a
summary estimate of the ZDV effect (the primary predictor of the study). Also, why do we
not use stcox here?
sts test rx // the log rank test
failure _d:
analysis time _t:

cens
days

Log-rank test for equality of survivor functions
|
Events
Events
rx
| observed
expected
--------+------------------------ZDV
|
17
25.64
Placebo |
38
29.36
--------+------------------------Total
|
55
55.00
chi2(1) =
Pr>chi2 =

5.48
0.0192

sts graph, by(rx) // K-M plot

6

Biostatistics 209

Lab #3

stcox is not used because it provides nothing. We get no estimates for the effect of rx
because it is defined as the strata and we have no other predictors in the model. We
can force a fit of the null model stratified by rx an follows:
stcox, estimate strata(rx)

but the output gives us nothing:
failure _d: cens
analysis time _t:

days

Iteration 0:
log likelihood = -293.76421
Refining estimates:
Iteration 0:
log likelihood = -293.76421
Stratified Cox regr. -- no ties
No. of subjects =
No. of failures =
Time at risk
=
Log likelihood

=

880
55
354872
-293.76421

Number of obs

=

880

LR chi2(0)
Prob > chi2

=
=

0.00
.

-----------------------------------------------------------------------------_t | Haz. Ratio
Std. Err.
z
P>|z|
[95% Conf. Interval]
-----------------------------------------------------------------------------Stratified by rx

i. Explore the time-dependent covariate approach.
stset days, failure(cens) id(id) // define survival data with multiple
// observations per subject
stsplit grp, at(365) // split time variable (days) at 1 year to generate new
// variable: grp. That is, generate multiple rows for each subject; one for each
// time period up to (and including) the time of censoring or time of death
7

Biostatistics 209

Lab #3

recode cens .=0 // recodes all newly generated rows to “censored” status
gen rx01=rx*(grp==0) // This set of commands generates 2 separate
gen rx1p=rx*(grp==365) // rx variables specific to each time interval;
// that is, rxXX only equals 0 if the patient is on ZDV and the dataset row
// corresponds to period XX
sort id grp // sort data so prioritized by id and then by grp within id
list id _t0 _t cens rx grp rx01 rx1p in 1/10, sepby(id)
// take a look at the data -- seems ok
+-----------------------------------------------------------+
| id
_t0
_t
cens
rx
grp
rx01
rx1p |
|-----------------------------------------------------------|
1. | 1
0
365
Censored
Placebo
0
1
0 |
2. | 1
365
502
AIDS/Death
Placebo
365
0
1 |
|-----------------------------------------------------------|
3. | 2
0
365
Censored
ZDV
0
0
0 |
4. | 2
365
496
Censored
ZDV
365
0
0 |
|-----------------------------------------------------------|
5. | 4
0
365
Censored
Placebo
0
1
0 |
6. | 4
365
565
Censored
Placebo
365
0
1 |
|-----------------------------------------------------------|
7. | 5
0
308
Censored
Placebo
0
1
0 |
|-----------------------------------------------------------|
8. | 6
0
365
Censored
Placebo
0
1
0 |
9. | 6
365
383
Censored
Placebo
365
0
1 |
|-----------------------------------------------------------|
10. | 7
0
365
Censored
Placebo
0
1
0 |
+-----------------------------------------------------------+
stcox rx??, nolog // fit Cox model – notice HR in 0 to 1 year is 3x that of after
failure _d: cens
analysis time _t:
id:

days
id

Cox regression -- Breslow method for ties
No. of subjects =
No. of failures =
Time at risk
=
Log likelihood

=

880
55
354872
-327.03114

Number of obs

=

1328

LR chi2(2)
Prob > chi2

=
=

8.75
0.0126

-----------------------------------------------------------------------------_t | Haz. Ratio
Std. Err.
z
P>|z|
[95% Conf. Interval]
-------------+---------------------------------------------------------------rx01 |
3.695978
1.859151
2.60
0.009
1.37898
9.906056
rx1p |
1.275121
.4702981
0.66
0.510
.618879
2.627222
------------------------------------------------------------------------------

Note that the stcox rx??, nolog command is shorthand for
stcox rx01 rx1p, nolog
8

Biostatistics 209

Lab #3
4. Checking the Cox Model for Cholesterol in lab3-pbc_a.dta

Declare the data lab3-pbc_a.dta to be survival time data
stset years, failure(status)

a. (Question 4.1) Fit the Cox model for the effect of cholesterol and run the Schoenfeld test for
the proportional hazards assumption. Is there evidence suggesting a violation of this
assumption?
stcox chol, sca(giveAname)
No. of subjects =
No. of failures =
Time at risk
=

284
114
1908.583167

Log likelihood

-565.65984

=

(Did you give the same name as before?)
Number of obs

=

284

LR chi2(1)
Prob > chi2

=
=

6.37
0.0116

-----------------------------------------------------------------------------_t | Haz. Ratio
Std. Err.
z
P>|z|
[95% Conf. Interval]
-------------+---------------------------------------------------------------cholest |
1.000758
.0002714
2.79
0.005
1.000226
1.00129

estat phtest
Test of proportional-hazards assumption
Time: Time
---------------------------------------------------------------|
rho
chi2
df
Prob>chi2
------------+--------------------------------------------------cholest
|
0.29729
7.77
1
0.0053
------------+---------------------------------------------------

The test indicates a violation of proportional hazards with a p-value of 0.005.
However, we need to look at the graph to understand the nature of the violation.
b. Graph the log hazard ratio. What does the graph suggest? Do you have any concerns
about the test?
lowess giveAname years, ytitle(cholesterol Log Hazard Ratio)

9

Biostatistics 209

Lab #3

-.005

cholesterol Log Hazard Ratio
0
.005
.01

.015

Lowess smoother

0

10
20
Time to Death (in Years)

30

bandwidth = .8

The graph shows two large outliers, which appears to be greatly affecting the correlations
with time. These two values may have a large effect on the test of proportional hazards.
You would want to redo the test without these points.
c. (Question 4.2) Try deleting some potential influential points and then re-run the plot and test
for the proportional hazards assumption. What do you conclude?
First, to re-run you either have to use a different name in the sca( ) option or drop
the variable you named it before.
drop giveAname
stcox chol if years <= 12, sca(giveAname)
No. of subjects =
No. of failures =
Time at risk
=

266
112
1338.001372

Log likelihood

-537.48194

=

Number of obs

=

266

LR chi2(1)
Prob > chi2

=
=

8.15
0.0043

-----------------------------------------------------------------------------_t | Haz. Ratio
Std. Err.
z
P>|z|
[95% Conf. Interval]
-------------+---------------------------------------------------------------cholest |
1.001022
.0003138
3.26
0.001
1.000407
1.001637
------------------------------------------------------------------------------

estat phtest, detail
Test of proportional-hazards assumption

Time: Time
---------------------------------------------------------------|
rho
chi2
df
Prob>chi2
------------+--------------------------------------------------cholest
|
0.15694
2.31
1
0.1282

10

Biostatistics 209

Lab #3

------------+--------------------------------------------------global test |
2.31
1
0.1282
----------------------------------------------------------------

.015

Here, we see that deleting the two points made the violation of proportional hazards no
longer significant (p>0.05). This is further reinforced by the graph, although it shows some
possible evidence against proportional
Lowess smoother
hazards.

-.005

cholesterol Log Hazard Ratio
0
.005
.01

For example, if you try
estat phtest, rank
estat phtest, log

0
bandwidth = .8

2

4
6
Time to Death (in Years)

8

10

or

i.e., so that you are considering a
transformation of the time axis, then you get
a statistically significant test (i.e., a
statistically significant correlation with the
residuals).

The bottom line is that the test of proportional hazards can be greatly affected by outlying
values. It is important to always accompany the test by a graph so that you judge the
directions, the magnitude of the violation and whether there appear to be points exerting a
large influence on the test.

11

